<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>베이직 컴포트 코튼 자켓 - 상품 페이지</title>
    <link rel="stylesheet" href="../static/css/products.css">
</head>
<body>
    <!-- 네비게이션 -->
    <nav>
        <div class="nav-container">
            <a href="/" class="logo">Gretel</a>
            
            <div class="nav-links">

                <nav>
        <a href="../category" class="icon-btn">카테고리</a>
        <a href="../cart" class="icon-btn">장바구니</a>
        <a href="../mypage" class="icon-btn">마이페이지</a>
        {% if request.session.get("user_id") %}
        <a href="../logout" class="icon-btn">로그아웃</a>
        {% else %}
        <a href="../login" class="icon-btn">로그인/회원가입</a>
        {% endif %}
      </nav>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="product-layout">
            <!-- 왼쪽 영역 (70%) -->
            <div class="left-section">
                <!-- 상품 이미지 -->
                <div class="product-images">
                    <!-- 태그 -->
                    <div class="product-tags">
                        {% for category in product.categories %}
                        <span class="badge primary">{{ category}}</span>
                        {% endfor %}
                    </div>
                    
                    <div class="main-image">
                        <img id="mainImage" src="../static{{ images[0].image_url }}" alt="상품 메인 이미지">
                    </div>
                    <div class="thumbnail-grid">
                        <div class="thumbnail active" onclick="selectImage(0)">
                            <img src="../static{{ images[0].image_url }}" alt="상품 이미지 1">
                        </div>
                        <div class="thumbnail" onclick="selectImage(1)">
                            <img src="../static{{ images[1].image_url }}" alt="상품 이미지 2">
                        </div>
                        <div class="thumbnail" onclick="selectImage(2)">
                            <img src="../static{{ images[2].image_url }}" alt="상품 이미지 3">
                        </div>
                        <div class="thumbnail" onclick="selectImage(3)">
                            <img src="../static{{ images[3].image_url }}    " alt="상품 이미지 4">
                        </div>
                    </div>
                </div>

                <!-- 탭 섹션 -->
                <div class="tabs">
                    <div class="tab-list">
                        <button class="tab-button active" onclick="showTab('info')">상품정보</button>
                        <button class="tab-button" onclick="showTab('reviews')">리뷰</button>
                    </div>

                    <!-- 상품정보 탭 -->
                    <div id="info" class="tab-content active">
                        <div class="product-info">
                            <!-- 상품 상세 이미지들 - 무신사 스타일로 간격 없이 쭉 이어지게 -->
                            {% for detail in detail_images %}
                            <img class="product-detail-image" src="/static{{ detail.image_url }}" alt="상품 상세 이미지 {{ loop.index }}">
                            {% endfor %}
                        </div>
                    </div>

<!-- 리뷰 탭 -->
<div id="reviews" class="tab-content">

    <!-- 리뷰 헤더 -->
    <div class="reviews-header">
        <h3 class="section-title">리뷰 ({{ review|length }})</h3>

        {# 안전한 평균 별점 계산 (0개 리뷰 시 0 처리) #}
        {% set total_rating = review | map(attribute='rating') | sum %}
        {% set count = review | length %}
        {% set avg_rating = (total_rating / count) if count > 0 else 0 %}

        <div class="stars">
            <div style="display: flex;">
                {% for i in range(1, 6) %}
                    {% if i <= avg_rating|round(0, 'floor') %}
                        <svg class="star filled" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    {% else %}
                        <svg class="star empty" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    {% endif %}
                {% endfor %}
            </div>
            <span>{{ avg_rating|round(1) }} ({{ review|length }})</span>
        </div>
    </div>

    <div class="separator"></div>

    <!-- 리뷰 목록 -->
    {% if review|length > 0 %}
        {% for r in review %}
        <div class="review-item">
            <div class="review-header">
                <div class="avatar">{{ r.username[0] }}</div>
                <div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 14px;">{{ r.username[:1] }}**</span>
                        <span class="badge" style="font-size: 10px;">구매확인</span>
                    </div>
                    <div class="review-meta">
                        <div style="display: flex;">
                            {% for i in range(1, 6) %}
                                {% if i <= r.rating %}
                                    <svg class="star filled" viewBox="0 0 24 24" style="width: 12px; height: 12px;">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                {% else %}
                                    <svg class="star empty" viewBox="0 0 24 24" style="width: 12px; height: 12px;">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span>2025.11.07 • 사이즈 M</span> <!-- 필요하면 백엔드에서 날짜/사이즈 넘겨도 됨 -->
                    </div>
                </div>
            </div>
            <p class="review-content">{{ r.comment }}</p>
        </div>
        {% endfor %}
    {% else %}
        <p class="no-reviews">아직 작성된 리뷰가 없습니다.</p>
    {% endif %}

</div>


                </div>
            </div>

            <!-- 오른쪽 영역 (30%) -->
            <div class="right-section">
                <div class="purchase-section">
                    <!-- 상품명 -->
                    <div style="margin-bottom: 16px;">
                        <h2 style="font-size: 20px; font-weight: 600; margin: 0;">{{ product.name }}</h2>
                    </div>

                    <!-- 가격 정보 -->
                    <div class="price-section">
                        <div class="price">
                            <span>{{ product.price | int }}원</span>
                        </div>
                    </div>

                    <div class="separator"></div>

                    <!-- 사이즈 선택 -->
                    <div class="form-group">
                        <label class="form-label">사이즈</label>
                        <select class="size-select" id="sizeSelect" onchange="selectSize()">
                            <option value="">사이즈를 선택하세요</option>
                            {% for size in product.sizes %}
                             <option value="{{ size }}">{{ size }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- 수량 선택 -->
                    <div class="form-group">
                        <label class="form-label">수량</label>
                        <input type="number" id="quantityInput" value="1" min="1" style="width: 60px;" onchange="updateQuantity()">
                    </div>
                    <div class="separator"></div>

                    <!-- 구매 버튼들 -->
                    <button class="btn btn-primary" id="buyBtn" disabled>바로구매</button>
                    <button class="btn btn-outline" id="cartBtn" disabled>장바구니</button>

                    <!-- 액션 버튼들 -->
                    <div class="action-buttons">
                        <button class="action-btn" onclick="toggleWishlist()">
                            <svg width="16" height="16" viewBox="0 0 24 24" class="heart-icon" id="heartIcon">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                            찜
                        </button>
                        <button class="action-btn" onclick="shareProduct()">
                            <svg width="16" height="16" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92S19.61 16.08 18 16.08z"/>
                            </svg>
                            공유
                        </button>
                    </div>

                    <!-- 배송 정보 -->
                    <div class="shipping-info">
                        <div class="shipping-row">
                            <span>배송비</span>
                            <span>무료배송</span>
                        </div>
                        <div class="shipping-row">
                            <span>배송예정</span>
                            <span>12/07(토) 도착예정</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        //세션 검증
        const user_session = '{{ user_id }}'
        console.log("유저 세션: ",user_session)

        // 상품 이미지 배열
        const productImages = [
            {% for image in images %}
                "/static{{ image.image_url }}"{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        // 상태 변수들
        let selectedImageIndex = 0;
        let selectedSize = '';
        let isWishlisted = false;
        const basePrice = 89000;
        
        // 로그인 상태 시뮬레이션 (localStorage 사용)
        let isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        let currentUser = localStorage.getItem('currentUser') || '';

        // 네비게이션 사용자 섹션 업데이트
        function updateUserSection() {
            const userSection = document.getElementById('userSection');
            
            if (isLoggedIn && currentUser) {
                userSection.innerHTML = `
                    <span style="margin-right: 12px; color: #6b7280;">안녕하세요, ${currentUser}님</span>
                    <a href="#" onclick="logout()" class="logout">로그아웃</a>
                `;
            } else {
                userSection.innerHTML = `
                    <a href="#" onclick="showLogin()">로그인/회원가입</a>
                `;
            }
        }

        // 이미지 선택 함수
        function selectImage(index) {
            selectedImageIndex = index;
            document.getElementById('mainImage').src = productImages[index];
            
            // 썸네일 활성화 상태 업데이트
            document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
        }

        // 탭 전환 함수
        function showTab(tabName) {
            // 모든 탭 버튼의 active 클래스 제거
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 모든 탭 컨텐츠 숨기기
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 선택된 탭 버튼에 active 클래스 추가
            event.target.classList.add('active');
            
            // 선택된 탭 컨텐츠 보이기
            document.getElementById(tabName).classList.add('active');
        }

        // 사이즈 선택 함수
        function selectSize() {
            const sizeSelect = document.getElementById('sizeSelect');
            selectedSize = sizeSelect.value;
            
            // 구매 버튼 활성화
            updateButtonStates();
        }

        let selectedQuantity = 1;

        // 수량 입력 변경 시
        function updateQuantity() {
            const qtyInput = document.getElementById('quantityInput');
            selectedQuantity = parseInt(qtyInput.value) || 1;
        }

        // 버튼 상태 업데이트
        function updateButtonStates() {
            const buyBtn = document.getElementById('buyBtn');
            const cartBtn = document.getElementById('cartBtn');
            const hasSize = selectedSize !== '';
            
            buyBtn.disabled = !hasSize;
            cartBtn.disabled = !hasSize;
        }

        // 찜하기 토글
        function toggleWishlist() {
            if (user_session != 'None' ){
            isWishlisted = !isWishlisted;
            const heartIcon = document.getElementById('heartIcon');
            const heartPath = heartIcon.querySelector('path');
            
            if (isWishlisted) {
                heartIcon.classList.add('active');
                heartPath.setAttribute('fill', '#dc2626');
                // localStorage에 찜 상태 저장
                localStorage.setItem('isWishlisted', 'true');
            } else {
                heartIcon.classList.remove('active');
                heartPath.setAttribute('fill', 'none');
                heartPath.setAttribute('stroke', 'currentColor');
                heartPath.setAttribute('stroke-width', '2');
                localStorage.setItem('isWishlisted', 'false');
            }
        }
            else{
                alert('로그인이 필요한 서비스입니다.')
            }
        }

        // 찜 상태 복원
        function restoreWishlistState() {
            const savedWishlist = localStorage.getItem('isWishlisted');
            if (savedWishlist === 'true') {
                isWishlisted = true;
                const heartIcon = document.getElementById('heartIcon');
                const heartPath = heartIcon.querySelector('path');
                heartIcon.classList.add('active');
                heartPath.setAttribute('fill', '#dc2626');
            }
        }

        // 공유하기
        function shareProduct() {
            if (navigator.share) {
                navigator.share({
                    title: '베이직 컴포트 코튼 자켓',
                    text: '부드러운 코튼 소재로 제작된 베이직 자켓',
                    url: window.location.href
                });
            } else {
                // 폴백: 클립보드에 URL 복사
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('상품 링크가 클립보드에 복사되었습니다.');
                });
            }
        }

        selectedPrice = {{ product.price }} * selectedQuantity;
        // 구매하기 버튼 클릭 이벤트
        document.getElementById('buyBtn').addEventListener('click', function() {
            if (selectedSize) {
                if(user_session != 'None'){
                fetch('/payment/ready',{
                     method: 'POST',
                      headers:{
                            'Content-Type':'application/json'
                      },
                      body:JSON.stringify({
                            user_id: '{{ user_id }}',
                            user: '{{ user }}',
                            product_id: '{{ product.id }}',
                            size: selectedSize,
                            quantity: selectedQuantity,
                            price: selectedPrice
                })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.checkout_url) {
                        window.location.href = data.checkout_url;
                        

                    } else {
                        alert(data.message);
                        console.error('결제 준비 실패:', data);
                    }
                })

            }else{
                alert('로그인이 필요한 서비스입니다.')
            }
        }
        });
        

        // 장바구니 버튼 클릭 이벤트
        document.getElementById('cartBtn').addEventListener('click', function() {
            if (selectedSize) { 
                // 장바구니에 상품 추가 로직
                fetch('/cart/add',{
                   method: 'POST',
                    headers:{
                        'Content-Type':'application/json'
                    },
                    body:JSON.stringify({
                        user_id: '{{ user_id }}',
                        user: '{{ user }}',
                        product_id: '{{ product.id }}',
                        product_name: '{{ product.name }},',
                        size: selectedSize,
                        quantity: selectedQuantity,
                        price: selectedPrice
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success){
                        alert(data.message);
                    }else{
                        alert(data.message);
                    }
                });
            }
        });


        // 초기화
        updateButtonStates();
        updateUserSection();
        restoreWishlistState();
    </script>
</body>
</html>